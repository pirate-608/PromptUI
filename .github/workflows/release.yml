name: Build and Release PromptUI

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller readability-lxml beautifulsoup4

      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: '3.27.7'

      - name: Add MinGW to PATH
        if: matrix.os == 'windows-latest'
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64

      - name: Build with PowerShell (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          ./scripts/build_windows.ps1

      - name: Build with Bash (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          bash ./scripts/build_unix.sh

      - name: Archive build output (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          Compress-Archive -Path dist/PromptUI/* -DestinationPath PromptUI-win.zip

      - name: Archive build output (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          tar -czf PromptUI-${{ matrix.os }}.tar.gz -C dist/PromptUI .

      - name: Upload Release Artifact
        uses: softprops/action-gh-release@v2
        with:
          files: |
            PromptUI-win.zip
            PromptUI-ubuntu-latest.tar.gz
            PromptUI-macos-latest.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
